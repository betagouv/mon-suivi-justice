<h1 class='form-title'><%= t('new_convict_title') %></h1>
<%= simple_form_for @convict, html: { class: 'basic-form' } do |f| %>
  <%= f.input :last_name %>
  <%= f.input :first_name %>
  <%= f.input :appi_uuid %>

  <% if current_user.work_at_spip? || current_user.admin? %>
    <%= f.association :user, collection: User.cpip.in_organization(current_user.organization),
                              label: t('.cpip_label'),
                              selected: selected_cpip_for(@convict, current_user)&.id,
                              as: :select,
                              include_blank: t('.cpip_blank_option'),
                              label_method: :name,
                              input_html: { class: 'form-select', id: 'agent-name-autocomplete' } %>
  <% end %>

  <%= f.input :phone, required: true %>
  <%= f.input :no_phone, input_html: { class: 'form-checkbox' },
                         label_html: { class: 'form-checkbox-label' },
                         wrapper_html: { class: 'form-checkbox-wrapper' } %>
  <%= f.input :refused_phone, input_html: { class: 'form-checkbox' },
                              label_html: { class: 'form-checkbox-label' },
                              wrapper_html: { class: 'form-checkbox-wrapper' } %>

  <% if @convict.duplicates.present? %>
    <% if policy_scope(@convict.duplicates).empty? %>
      <div class='new-convict-duplicate-warning'>
        <% @convict.duplicates.each do |duplicate| %>
          <% dep = duplicate.departments.first %>
          <p><%= t('new_convict_duplicate_warning5', name: dep.name, number: dep.number)%></p>
        <% end %>
      </div>
    <% else %>
      <div class='new-convict-duplicate-warning'>
        <p><%= t('new_convict_duplicate_warning1')%></p>
        <% @convict.duplicates.each do |duplicate| %>
          <div class='new-convict-duplicate-link'>
            <%= link_to t('new_convict_duplicate_link', name: duplicate.name), convict_path(duplicate), target: "_blank" %>
          </div>
        <% end %>
        <p class='new-convict-duplicate-explanation'><%= t('new_convict_duplicate_warning2')%></p>
        <p class='new-convict-duplicate-explanation'><%= t('new_convict_duplicate_warning3')%></p>
        <p><%= t('new_convict_duplicate_warning4')%></p>
      </div>
    <% end %>

    <div class='new-convict-submits-container'>
      <%= f.hidden_field :force_duplication, value: true  %>
      <%= f.button :button, id: 'submit-no-appointment', class: 'form-submit-button', name: 'no-appointment' do %>
        <%= t('submit') %><br><%= t('new_convict_submit') %>
      <% end %>
      <%= f.button :button, id: 'submit-with-appointment', class: 'form-submit-button', name: 'with-appointment' do %>
        <%= t('submit') %><br><%= t('new_convict_first_appointment') %>
      <% end %>
    </div>
  <% else %>
    <div class='new-convict-submits-container'>
      <%= f.button :button, id: 'submit-no-appointment', class: 'form-submit-button', name: 'no-appointment' do %>
        <%= t('submit') %><br><%= t('new_convict_submit') %>
      <% end %>
      <%= f.button :button, id: 'submit-with-appointment', class: 'form-submit-button', name: 'with-appointment' do %>
        <%= t('submit') %><br><%= t('new_convict_first_appointment') %>
      <% end %>
    </div>
  <% end %>
<% end %>
