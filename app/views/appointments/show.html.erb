<h1 class='show-title'><%= t('show_appointment_title') %></h1>

<% if @convict.passed_appointments.present? %>
  <% @convict.passed_appointments.each do |apt| %>
    <div class='appointment-fulfilment-container'>
      <div class='appointment-fulfilment-prompt-container'>
        <%= t('show-convict-fulfilment-prompt', name: @convict.name,
                                                place: @appointment.slot.agenda.place.name,
                                                date: @appointment.slot.date,
                                                time: @appointment.slot.starting_time.to_s(:time)) %>
      </div>

      <div class='appointment-fulfilment-controls-container'>
        <%= button_to t('yes'), appointment_fulfil_path(@appointment),
                                method: :put,
                                id: 'show-convict-fulfil-button',
                                class: 'show-convict-fulfil-button' %>

        <%= button_tag t('no'), type: 'button',
                                class: 'show-convict-miss-button',
                                data: { 'micromodal-trigger': "missed-appointment-modal-#{@appointment.id}" } %>

        <%= button_to t('show-convict-fulfilment-excused'), appointment_excuse_path(@appointment),
                                                            method: :put,
                                                            id: 'show-convict-excuse-button',
                                                            class: 'show-convict-excuse-button' %>
      </div>
    </div>

    <%= render 'missed_appointment_modal', apt: @appointment %>
  <% end %>
<% end %>

<div class='show-profile-container'>
  <div class='show-data-container'>
    <div class='show-data-item-container'>
      <div class='show-data-label'>
        <%= t('activerecord.attributes.convict.title')%>
      </div>
      <div class='show-data-item'>
        <%= t("activerecord.attributes.convict.convict_titles.#{@convict.title}") %>
      </div>
    </div>

    <div class='show-data-item-container'>
      <div class='show-data-label'>
        <%= t('activerecord.attributes.convict.last_name')%>
      </div>
      <div class='show-data-item'>
        <%= @convict.last_name.upcase %>
      </div>
    </div>

    <div class='show-data-item-container'>
      <div class='show-data-label'>
        <%= t('activerecord.attributes.convict.first_name')%>
      </div>
      <div class='show-data-item'>
        <%= @convict.first_name.capitalize %>
      </div>
    </div>

    <div class='show-data-item-container'>
      <div class='show-data-label'>
        <%= t('activerecord.attributes.convict.phone')%>
      </div>
      <div class='show-data-item'>
        <% if @convict.no_phone? %>
          <%= t('activerecord.attributes.convict.no_phone')%>
        <% elsif @convict.refused_phone? %>
          <%= t('activerecord.attributes.convict.refused_phone')%>
        <% else %>
          <%= @convict.display_phone %>
        <% end %>
      </div>
    </div>

    <div class='show-data-item-container'>
      <div class='show-data-label'>
        <%= t('activerecord.attributes.convict.prosecutor_number')%>
      </div>
      <div class='show-data-item'>
        <%= @convict.prosecutor_number %>
      </div>
    </div>
  </div>

  <div class='show-button-to-edit-container'>
    <%= button_to t('see_profile'), convict_path(@convict.id),
                                    method: :get,
                                    class: 'show-button-to-edit' %>
  </div>
</div>

<div class='show-appointment-container'>
  <div class='show-appointment-summon-container'>
    <div class='show-appointment-data-container'>
      <div class='show-appointment-summon-data'>
        <div class='show-appointment-summon-title'>
          <%= t('appointment_place') %>
        </div>
        <div class='show-appointment-summon-item'>
          <%= @appointment.slot.agenda.place.name %>
        </div>
      </div>

      <div class='show-appointment-summon-data'>
        <div class='show-appointment-summon-title'>
          <%= t('appointment_date') %>
        </div>
        <div class='show-appointment-summon-item'>
          <%= @appointment.slot.date %>
        </div>
      </div>

      <div class='show-appointment-summon-data'>
        <div class='show-appointment-summon-title'>
          <%= t('appointment_starting_time') %>
        </div>
        <div class='show-appointment-summon-item'>
          <%= @appointment.slot.starting_time.to_s(:time) %>
        </div>
      </div>

      <div class='show-appointment-summon-data'>
        <div class='show-appointment-summon-title'>
          <%= t('appointment_origin_department') %>
        </div>
        <div class='show-appointment-summon-item'>
          <%= t("activerecord.attributes.appointment.origin_departments.#{@appointment.origin_department}") %>
        </div>
      </div>

      <div class='show-appointment-summon-data'>
        <div class='show-appointment-summon-title'>
          <%= t('appointment_state') %>
        </div>
        <div class='show-appointment-summon-item'>
          <%= @appointment.human_state_name %>
        </div>
      </div>
    </div>

    <div class='show-appointment-controls-container'>
      <% if  @appointment.booked? %>
        <%= button_to t('cancel'), appointment_cancel_path(@appointment),
                                   method: :put,
                                   data: { confirm: t('cancel_appointment_warning') },
                                   class: 'show-button-to-edit' %>
      <% end %>
    </div>
  </div>
</div>

<h2 class='show-secondary-title'><%= t('show_convict_history_title') %></h2>

<div class='show-history-container'>
  <% @history_items.each do |history_item| %>
    <% if history_item.category == 'appointment' %>
      <div class='show-history-item-container'>
        <div class='show-history-item-header'>
          <div class='show-history-item-icon'>
            <%= fa_icon 'circle' %>
          </div>
          <div class='show-history-item-creation'>
            <%= history_item.created_at.strftime('%d/%m/%Y %H:%M') %>
          </div>
        </div>

        <div class='show-history-item'>
          <div class='show-history-item-title'>
            <%= t("show_history_#{history_item.event}_title") %>
          </div>

          <div class='show-history-item-content'>
            <%= t("show_history_#{history_item.event}", name: @convict.name,
                                                        place: history_item.appointment.slot.agenda.place.name,
                                                        date: history_item.appointment.slot.date,
                                                        time: history_item.appointment.slot.starting_time.to_s(:time)) %>
          </div>
        </div>
      </div>
    <% elsif history_item.category == 'notification' %>
      <% next if ['program_reminder_notification', 'cancel_reminder_notification'].include?(history_item.event) %>

      <div class='show-history-item-container'>
        <div class='show-history-item-header'>
          <div class='show-history-item-icon'>
            <%= fa_icon 'circle', class: "icon_#{history_item.event}" %>
          </div>
          <div class='show-history-item-creation'>
            <%= history_item.created_at.strftime('%d/%m/%Y %H:%M') %>
          </div>
        </div>

        <div class='show-history-item'>
          <div class='show-history-item-title'>
            <%= t("show_history_#{history_item.event}_title") %>
          </div>

          <div class='show-history-item-content'>
            <%= t("show_history_#{history_item.event}", name: @convict.name,
                                                        content: history_item.appointment.send(history_item.notification_role).content) %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<%= javascript_pack_tag 'appointment_show' %>
