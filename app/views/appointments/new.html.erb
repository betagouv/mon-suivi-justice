<div class="fr-grid-row fr-grid-row--gutters fr-grid-row--center">
<div class="fr-col-6" data-controller="appointment-new">
  <h2 class='form-title' id="appointment-form-title"><%= t('new_appointment_title') %><%= @convict ? " pour #{@convict.full_name}" : "" %></h2>
  <%= simple_form_for @appointment, url: appointments_path(convict_id: @convict&.id), html: { "data-appointment-new-target": "newAppointmentForm" } do |f| %>
    <div>
      <% if @convict %>
        <%= f.input :convict_id, as: :hidden, input_html: { value: @convict.id, "data-appointment-new-target": "convictSelectInput" } %>
      <% else %>
        <%= f.association :convict, collection: policy_scope(Convict.all),
                                    label: t('activerecord.models.convict', count: 1),
                                    as: :select,
                                    label_method: :name,
                                    input_html: {
                                      class: 'form-select', 
                                      id: 'convict-name-autocomplete',
                                      "data-appointment-new-target": "convictSelectInput",
                                    } %>
      <% end %>

      <div class="appointment-form-cpip-container" id="cpip-container">
        <% if can_be_linked_to_user?(@convict, current_user) %>
          <div class="form-input-wrapper radio_buttons optional appointment_user_is_cpip">
            <label class="radio_buttons optional form-label"><%= t('appointments.new.is_cpip_label')%></label>
            <input type="hidden" name="appointment[user_is_cpip]" value="">
            <span class="radio appointment-form-cpip-input-container"><label for="appointment_user_is_cpip_1" class="appointment-form-cpip-input-label"><input class="radio_buttons optional form-text-input appointment-form-cpip-input" type="radio" value="1" checked="checked" name="appointment[user_is_cpip]" id="appointment_user_is_cpip_1">Oui</label></span>
            <span class="radio appointment-form-cpip-input-container"><label for="appointment_user_is_cpip_0" class="appointment-form-cpip-input-label"><input class="radio_buttons optional form-text-input appointment-form-cpip-input" type="radio" value="0" name="appointment[user_is_cpip]" id="appointment_user_is_cpip_0">Non</label></span></div>
       <% end %>
      </div>

      <div data-controller="appointment-extra-field-display">
        <div class='appointment-form-appointment-type-container' id='appointment-type-container' data-appointment-new-target="container" data-container-type="appointmentType" style=<%= @convict ? "display: block" : "display: none" %>>
          <%= f.input :appointment_appointment_type_id, collection: appointment_types_for_user(current_user),
                                                        label: t('activerecord.models.appointment_type'),
                                                        as: :fake_select,
                                                        label_method: :name,
                                                        input_html: { class: 'form-select', 
                                                        "data-appointment-extra-field-display-target": "selectAppointmentTypeInput",
                                                        "data-appointment-new-target": "selectAppointmentTypeInput", 
                                                        "data-action": "change->appointment-extra-field-display#change change->appointment-new#changeAptType" } %>
        </div>

        <div class="d-none" data-appointment-extra-field-display-target="extraFieldsContainer">
          <%= f.fields_for :appointment_extra_fields do |extra_field_form|%>
            <%= extra_field_form.input :extra_field_id, as: :hidden, input_html: {"data-appointment-extra-field-display-target": "extraFieldInputs", "data-apt-type": @extra_fields[extra_field_form.index].appointment_type_ids, "data-organization": @extra_fields[extra_field_form.index].organization.id}, disabled: true %>
            <%= extra_field_form.input :value, label: @extra_fields[extra_field_form.index]&.name, input_html: { :type => @extra_fields[extra_field_form.index]&.data_type, "data-appointment-extra-field-display-target": "extraFieldInputs", "data-apt-type": @extra_fields[extra_field_form.index].appointment_type_ids, "data-organization": @extra_fields[extra_field_form.index].organization.id}, disabled: true %>
            <%=  @extra_fields[extra_field_form.index].inspect %>
          
          <% end%>
        </div>
      </div>

      <div class='' id='cities-container'></div>
      <div class='appointment-form-prosecutor-container' data-container-type="prosecutor" id='prosecutor-container' data-appointment-new-target="container"></div>
      <div class='appointment-form-places-container' data-container-type="place" id='places-container' data-appointment-new-target="container"></div>
      <div class='appointment-form-agendas-container' data-container-type="agenda" id='agendas-container' data-appointment-new-target="container"></div>
      <div class='appointment-form-slot-fields-container' data-container-type="slotField" id='slot-fields-container' data-appointment-new-target="container"></div>
    </div>

    <div class='appointment-form-slots-container' data-container-type="slot" data-appointment-new-target="container" id='slots-container'></div>
    <div id='submit-btn-container' data-appointment-new-target="submitButtonContainer" class='fr-grid-row fr-grid-row--center fr-mt-2w'>
        <div>
          <% if @convict && !@convict.phone.blank? %>
            <button type='submit' name='send_sms' value="1" class='fr-btn fr-mr-2w' id='submit-new-appointment-sms'>
              <%= t('submit_sms')%>
            </button>
          <% end %>
          <button type='submit' name='send_sms' value="0" class='fr-btn fr-btn--secondary' id='submit-new-appointment-no-sms'>
            <%= t('submit_no_sms')%>
          </button>
        </div>
        <div class="fr-grid-row fr-grid-row--center fr-mt-1w">   
          <span><%= t('new-appointment-warning') %></span>
          <span><%= t('new-appointment-confirmation-warning') %></span>
        </div>
    </div>
  <% end %>

</div>
