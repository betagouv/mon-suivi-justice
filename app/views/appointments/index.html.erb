<div class='index-header-container'>
  <div class='index-header-filters-container'>
    <%= search_form_for @q, class: 'index-header-filters-form', id: 'index-header-filters-form' do |f| %>
      <div class='index-header-filters-fields-container'>
        <%= f.search_field :slot_date_eq, id: 'index-appointment-date-filter',
                            class: 'index-header-search-field',
                            value: @q.slot_date_eq ? @q.slot_date_eq.strftime('%d/%m/%Y') : '',
                            placeholder: t('search-appointment-placeholder') %>

        <%# TODO: there is for the moment only one department per organization.
        When there will be more, this logic will need to be adapted. %>
        <%= f.select :slot_agenda_place_id_eq, options_from_collection_for_select(Place.in_organization(current_user.organization), 'id', 'name', @q.slot_agenda_place_id_eq),
                                               { include_blank: t('index_slot_place_filter') },
                                               { class: 'form-select index-header-filter-field' } %>

        <%= f.select :slot_agenda_id_eq, options_from_collection_for_select(Agenda.in_organization(current_user.organization), 'id', 'name', @q.slot_agenda_id_eq),
                                         { include_blank: t('index-appointment-agenda-filter') },
                                         { class: 'form-select index-header-filter-field' } %>

        <%= f.select :slot_appointment_type_id_eq, options_from_collection_for_select(appointment_types_for_user(current_user), 'id', 'name', @q.slot_appointment_type_id_eq),
                                                   { include_blank: t('index-slots-appointment-type-filter') },
                                                   { class: 'form-select index-header-filter-field' } %>
      </div>
    <% end %>

    <div class='index-header-filters-button-container'>
      <%= button_tag t('filter'), type: 'submit', class: 'index-header-filters-button', form: 'index-header-filters-form' %>
      <%= button_to t('index-appointment-reinit-filter'), appointments_path,
                                                          params: { q: {slot_date_eq: Date.today.to_s }},
                                                          class: 'index-header-filters-button',
                                                          method: :get %>
    </div>
  </div>

  <div class='index-header-controls-container'>
    <% if policy(:appointment).new? %>
      <%= button_to t('new_appointment_title'), new_appointment_path,
                                                class: 'link-to-new-appointment-button',
                                                form_class: 'link-to-new-appointment-form',
                                                method: :get %>
    <% end %>

    <%= button_to t('print_button'), 'fake_link',
                                      class: 'bex-print-button',
                                      onclick: 'window.print();return false;'%>
  </div>
</div>

<div class='appointments-container'>
  <div class='index-table-container'>
    <div class='index-table-header'>
      <div class='appointments-column-1'>
        <%= sort_link(@q, 'convict_last_name', t('activerecord.models.convict'), default_order: :desc) %>
      </div>

      <div class='appointments-column-2'>
        <%= sort_link(@q, 'slot_place_name', t('appointment_place'), default_order: :desc) %>
      </div>

      <div class='appointments-column-3'>
        <%= sort_link(@q, 'slot_date', t('activerecord.attributes.slot.date'), default_order: :desc) %>
      </div>

      <div class='appointments-column-4'>
        <%= sort_link(@q, 'slot_starting_time', t('activerecord.attributes.slot.starting_time'), default_order: :desc) %>
      </div>

      <div class='appointments-column-5'>
        <%= sort_link(@q, 'slot_agenda', t('activerecord.models.agenda'), default_order: :desc) %>
      </div>

      <div class='appointments-column-6'>
        <%= sort_link(@q, 'slot_appointment_type', t('activerecord.attributes.slot.appointment_type'), default_order: :desc) %>
      </div>
    </div>

    <div class='index-list-container'>
      <% @appointments.each do |appointment| %>
        <div class='index-list-line-container'>
          <div class='index-list-item-container'>
            <div class='appointments-column-1'>
              <%= appointment.convict.name %>
            </div>

            <div class='appointments-column-2'>
              <%= appointment.slot.agenda.place.name %>
            </div>

            <div class='appointments-column-3'>
              <%= appointment.slot.date.to_s(:base_date_format) %>
            </div>

            <div class='appointments-column-4'>
              <%= appointment.slot.starting_time.to_s(:time) %>
            </div>

            <div class='appointments-column-5'>
              <%= appointment.slot.agenda.name %>
            </div>

            <div class='appointments-column-6'>
              <%= appointment.slot.appointment_type.name %>
            </div>
          </div>

          <div class='index-list-controls-container'>
            <div class='index-appointments-state-container'>
              <%= t('index-appointment-state') %>
              <% if appointment.in_the_past? && appointment.booked? && policy(@appointment).fulfil? %>
                <div class='index-appointments-state-controls-container'>
                  <%= button_to t('activerecord.state_machines.states.fulfiled'), appointment_fulfil_path(appointment),
                                                                                  method: :put,
                                                                                  class: 'index-appointments-fulfil-button' %>

                  <%= button_tag t('activerecord.state_machines.states.no_show'), type: 'button',
                                                                                  class: 'index-appointments-miss-button',
                                                                                  data: { 'micromodal-trigger': "missed-appointment-modal-#{appointment.id}" } %>

                  <%= button_to t('activerecord.state_machines.states.excused'), appointment_excuse_path(appointment),
                                                                                 method: :put,
                                                                                 class: 'index-appointments-excuse-button' %>
                </div>

                <%= render 'missed_appointment_modal', apt: appointment %>
              <% else %>
                <%= fa_icon 'circle', class: "index-appointments-state-icon icon_#{appointment.state}" %> <%= appointment.human_state_name %>
              <% end %>
            </div>

            <% if policy(:appointment).show? %>
              <%= link_to t('index-appointment-see-data'), appointment_path(appointment), class: 'index-appointments-see-infos' %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <%= paginate @appointments %>
  </div>
</div>

<%= javascript_pack_tag 'appointment_index' %>
