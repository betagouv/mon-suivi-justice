<div class='bex-agendas-container'>
  <div class='bex-agendas-tools-container'>
    <% if !@agenda.nil? %>
      <%= button_to t('print_button'), agenda_spip_path(format: :pdf),
                                      method: :get,
                                      params: {date: params[:date], agenda_id: @agenda.id, place_id: @place.id},
                                      form: { target: '_blank' },
                                      class: 'bex-print-button' %>
    <% end %>
  </div>
  <div class='bex-agendas-date-container'>
    <div class='bex-date-title-container'>
      <%= t('bex.spip.appointments_title') %>
    </div>
    <div class='bex-filters-container'>
      <%= form_tag agenda_spip_path, method: 'get' do %>
        <div class="bex-form-input-wrapper">
          <%= label_tag 'date', 'Date :' %>
          <%= select_tag :date, options_for_select(formated_month_for_select(six_next_months), params[:date]),
                                id: 'spip-appointments-month-select',
                                class: 'form-select form-text-input spip-date-select',
                                onchange: 'this.form.submit()' %>
        </div>

        <% if @places.count > 0 %>
          <div class="bex-form-input-wrapper">
            <%= label_tag 'place_id', 'Lieu :' %>
            <%= select_tag :place_id, options_from_collection_for_select(@places, 'id', 'name', @place.id), class: 'form-select form-text-input spip-place-select', onchange: 'this.form.submit()' %>
          </div>
        <% end %>
        <% if @agendas.count > 1 %>
          <div class="bex-form-input-wrapper">
            <%= label_tag 'agenda_id', 'Agenda :' %>
            <%= select_tag :agenda_id, options_from_collection_for_select(@agendas, 'id', 'name', @agenda.id), class: 'form-select form-text-input spip-agenda-select', onchange: 'this.form.submit()' %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <% if @agenda.nil? %>
    <p class='bex-agenda-spip-no-agenda'><%= t('bex.spip.no_agenda_available') %></p>
  <% else %>
    <% open_days_for_the_month(@current_date).each do |day| %>
      <% next if @agenda.slots_for_date(day, @appointment_type).count == 0 %>
        <div class="fr-table fr-table--bordered">
          <table class="agenda-jap-table">
              <caption class='spip-agenda-header'><%= day %></caption>
              <thead>
                <th scope="col">
                  <%= t('bex.jap.header_hour') %>
                </th>
                <th scope="col">
                  <%= t('bex.jap.header_last_name') %>
                </th>
                <th scope="col">
                  <%= t('bex.jap.header_first_name') %>
                </th>
                <th scope="col">
                  <%= t('bex.jap.header_prosecutor') %>
                </th scope="col">
                <th scope="col">
                  <%= t('bex.jap.header_origin') %>
                </th>
                <th scope="col">
                  <%= t('bex.jap.header_role') %>
                </th>
                <% @agenda.organization&.extra_fields.select(&:relate_to_spip?)&.each do |extra_field| %>
                  <th scope="col">
                    <%= extra_field.name %>
                  </th>
                <% end %>
                <% if current_user.work_at_bex? || current_user.admin? || current_user.local_admin? %>
                  <th scope="col">
                    <%= t('bex.jap.header_case_prepared') %>
                  </th>
                <% end %>
              </thead>
              <tbody>
            <% @agenda.slots_for_date(day, @appointment_type).each do |slot| %>
              <% appointments = slot.appointments.active %>
              <% slot.capacity.times do |i| %>
                <tr>
                  <th>
                    <% if i == 0 %>
                      <%= slot.localized_time.to_s(:lettered) %>
                    <% end %>
                  </th>
                  <th>
                    <% unless appointments[i].nil? %>
                      <%= link_to convict_path(appointments[i]&.convict), class: 'index-control' do %>
                        <%= appointments[i]&.convict&.last_name&.upcase %>
                      <% end %>
                    <% end %>
                  </th>
                  <th>
                    <%= appointments[i]&.convict&.first_name %>
                  </th>
                  <th>
                    <%= appointments[i]&.prosecutor_number %>
                  </th>
                  <th>
                    <% if appointments[i].present? && appointments[i].creating_organization.present? %>
                      <%= appointments[i].creating_organization.name %>
                    <% elsif appointments[i].present? && appointments[i].inviter_user_id.present? %>
                      <% user = User.find(appointments[i].inviter_user_id) %>
                      <%= user.organization.name %>
                    <% end %>
                  </th>
                  <th>
                    <% if appointments[i].present? %>
                      <% if appointments[i].origin_department.present? %>
                        <%= t("activerecord.attributes.appointment.origin_departments.#{appointments[i].origin_department}") %>
                      <% elsif appointments[i].inviter_user_id.present? %>
                        <% user = User.find(appointments[i].inviter_user_id) %>
                        <%= t("activerecord.attributes.user.user_roles.#{user.role}") %>
                      <% end %>
                    <% end %>
                  </th>

                  <% @agenda.organization.extra_fields&.select(&:relate_to_spip?).each do |extra_field| %>
                    <% if extra_field.appointment_update? && appointments[i].present? %>
                      <th data-controller="table-update-field">
                        <input data-table-update-field-target="inputField" data-action="table-update-field#update" data-appointment="<%= appointments[i].id %>" data-extra-field="<%= extra_field.id %>"
                          class="fr-input agenda-jap-input" type="<%= extra_field.data_type %>" value="<%= extra_field.appointment_extra_fields_for_appointment(appointments[i].id)&.value if appointments[i].present? %>" /> 
                      </th>
                    <% else %>
                      <th>
                        <%= display_extra_field(extra_field, appointments[i]) %>
                      </th>
                    <%end%>
                  <% end %>
                  <% if current_user.work_at_bex? || current_user.admin? || current_user.local_admin? %>
                    <th>
                      <% if appointments[i].present? %>
                        <%= form_tag appointment_prepare_path(appointments[i]), method: 'put', class: 'bex-agenda-case-prepared-form' do %>
                          <%= check_box_tag "case-prepared-#{appointments[i].id}",
                                            true,
                                            appointments[i].case_prepared,
                                            class: 'bex-agenda-case-prepared-checkbox',
                                            onchange: 'this.form.submit()' %>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% end %>
              </tbody>
          </table>
        </div>
    <% end %>
  <% end %>
</div>
